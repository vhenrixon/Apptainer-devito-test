Bootstrap: docker
From: ubuntu:22.04

%environment
    # Set Python path
    export PYTHONPATH=/usr/lib/python3/dist-packages:$PYTHONPATH
    
    export DEBIAN_FRONTEND=noninteractive
    # MPI environment variables for bind method
    # Adjust MPI_DIR path based on your host's MPI installation
    export PATH="$MPI_DIR/bin:$PATH"
    export LD_LIBRARY_PATH="$MPI_DIR/lib:$LD_LIBRARY_PATH"
    export NVIDIA_VISIBLE_DEVICES=all
    export NVIDIA_DRIVER_CAPABILITIES=compute,utility
    export DEVITO_MPI=1
    export DEVITO_PLATFORM=nvidiaX
    export DEVITO_ARCH=pgcc
    export DEVITO_LANGUAGE=openacc

%post -c /bin/bash
    export DEBIAN_FRONTEND=noninteractive
    # Update package lists
    apt-get update -y
    
    # Install essential packages
    apt-get install -y \
        build-essential \
        wget \
        curl \
        git \
        vim \
        software-properties-common \
        ca-certificates
    
    # Install Python 3 and related packages
    apt-get install -y \
        python3 \
        python3-pip \
        python3-dev \
        python3-venv \
        python3-setuptools \
        python3-wheel
    
    # Create symbolic link for python command
    ln -sf /usr/bin/python3 /usr/bin/python
    
    python3 -m venv /opt/venv
    source /opt/venv/bin/activate
    # Create workspace
    mkdir -p /workspace
    cd /workspace

    # Clone Devito
    git clone https://github.com/devitocodes/devito.git
    cd devito

    # Upgrade pip
    python3 -m pip install --upgrade pip
    
    # Install common Python scientific packages (excluding mpi4py)
    pip install -r requirements.txt
    pip install -r requirements-optional.txt
    pip install -r requirements-testing.txt
    pip install -r requirements-nvidia.txt
    pip install devito
    
    cd 
    # Install development tools that may be needed
    apt-get install -y \
        pkg-config \
        libhdf5-dev \
        libnetcdf-dev \
        gfortran
    
    # Clean up to reduce image size
    apt-get clean
    rm -rf /var/lib/apt/lists/*

%runscript
    # Default command when container is run
    exec "$@"

%labels
    Author your-name@your-institution.edu
    Version v1.0
    Description Container with Python and MPI bind method support

%help
    This container includes:
    - Ubuntu 22.04 base
    - Python 3.10+ with pip
    - Development tools
    
    